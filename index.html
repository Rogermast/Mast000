<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAST Soluci√≥n CCTV</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #1976d2;
            --secondary-color: #2196f3;
            --accent-color: #ff9800;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-color: #212121;
            --light-color: #f5f5f5;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            padding: 10px;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .main-container {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }
        
        .map-container {
            flex: 1;
            height: 600px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, button, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .results-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        .summary-table {
            margin-top: 15px;
        }
        
        .summary-table td {
            font-weight: bold;
            background-color: #f5f5f5;
        }
        
        .device-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        .status-bar {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            font-size: 14px;
        }
        
        .node-marker {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .node-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .hidden {
            display: none;
        }
        
        .thumb {
            width: 50px;
            height: 40px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .action-btn-group {
            display: flex;
            gap: 5px;
        }
        
        .action-btn-group button {
            font-size: 11px;
            padding: 4px 6px;
            width: auto;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-height: none;
            }
            
            .map-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MAST Soluci√≥n CCTV</h1>
        <p>Sistema Integral para Dise√±o e Implementaci√≥n de Proyectos de Seguridad Electr√≥nica</p>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="section">
                <div class="section-title">Configuraci√≥n de Nodos</div>
                <div class="form-group">
                    <label for="numNodes">N√∫mero de Nodos:</label>
                    <input type="number" id="numNodes" min="1" max="10" value="1">
                </div>
                <button id="generateNodes">Generar Nodos</button>
                
                <div id="nodesContainer" class="hidden">
                    <div class="section-title">Configuraci√≥n por Nodo</div>
                    <div id="nodesList"></div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Dispositivos</div>
                <div class="form-group">
                    <label for="deviceType">Tipo de Dispositivo:</label>
                    <select id="deviceType">
                        <option value="camera">C√°mara</option>
                        <option value="switch">Switch</option>
                        <option value="speaker">Parlante IP</option>
                        <option value="monitor">Monitor/NVR</option>
                        <option value="antenna">Antena</option>
                        <option value="solar">Panel Solar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deviceNode">Nodo Asociado:</label>
                    <select id="deviceNode">
                        <option value="">Sin asignar</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button id="addDeviceByClick">Agregar por Clic</button>
                    <button id="addDeviceByLocation">Ubicaci√≥n Actual</button>
                </div>
                <div class="device-list" id="devicesList">
                    <p>No hay dispositivos agregados</p>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Rutas</div>
                <div class="btn-group">
                    <button id="startRoute">Iniciar Ruta</button>
                    <button id="deleteLastRoute" class="btn-danger">Eliminar √öltima</button>
                </div>
                <div class="device-list" id="routesList">
                    <p>No hay rutas definidas</p>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Proyecto</div>
                <div class="form-group">
                    <label for="projectName">Nombre del Proyecto:</label>
                    <input type="text" id="projectName" placeholder="Mi Proyecto CCTV">
                </div>
                <div class="form-group">
                    <label for="projectNotes">Notas del Proyecto:</label>
                    <textarea id="projectNotes" rows="3" placeholder="Notas adicionales..."></textarea>
                </div>
                <div class="btn-group">
                    <button id="saveProject" class="btn-success">Guardar</button>
                    <button id="loadProject">Cargar</button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <div class="results-container">
        <div class="tabs">
            <div class="tab active" data-tab="summary">Resumen</div>
            <div class="tab" data-tab="devices">Dispositivos</div>
            <div class="tab" data-tab="routes">Rutas</div>
            <div class="tab" data-tab="materials">Materiales</div>
            <div class="tab" data-tab="export">Exportar</div>
        </div>
        
        <div class="tab-content active" id="summary">
            <div class="section-title">Resumen del Proyecto</div>
            <table class="summary-table">
                <tr>
                    <th>Concepto</th>
                    <th>Valor</th>
                </tr>
                <tr>
                    <td>Total de Nodos</td>
                    <td id="totalNodes">0</td>
                </tr>
                <tr>
                    <td>Total de C√°maras</td>
                    <td id="totalCameras">0</td>
                </tr>
                <tr>
                    <td>Total de Switches</td>
                    <td id="totalSwitches">0</td>
                </tr>
                <tr>
                    <td>Total de Otros Dispositivos</td>
                    <td id="totalOtherDevices">0</td>
                </tr>
                <tr>
                    <td>Total de Rutas</td>
                    <td id="totalRoutes">0</td>
                </tr>
                <tr>
                    <td>Longitud Total de Rutas (m)</td>
                    <td id="totalRouteLength">0</td>
                </tr>
            </table>
        </div>
        
        <div class="tab-content" id="devices">
            <div class="section-title">Lista de Dispositivos</div>
            <table id="devicesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Nombre</th>
                        <th>Nodo</th>
                        <th>Comentarios</th>
                        <th>Img1</th>
                        <th>Img2</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <tr>
                        <td colspan="8">No hay dispositivos agregados</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="routes">
            <div class="section-title">Lista de Rutas</div>
            <table id="routesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Distancia (m)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="routesTableBody">
                    <tr>
                        <td colspan="6">No hay rutas definidas</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tab-content" id="materials">
            <div class="section-title">C√°lculo de Materiales</div>
            <table class="summary-table">
                <tr>
                    <th>Concepto</th>
                    <th>Valor</th>
                </tr>
                <tr>
                    <td>Total de Cables UTP</td>
                    <td id="totalUTPCables">0</td>
                </tr>
                <tr>
                    <td>Cableado UTP en C√°maras (m)</td>
                    <td id="utpCablingCameras">0.0</td>
                </tr>
                <tr>
                    <td>Cableado UTP en Nodos (m)</td>
                    <td id="utpCablingNodes">0.0</td>
                </tr>
                <tr>
                    <td>Total Cableado UTP (m)</td>
                    <td id="totalUTPCabling">0.0</td>
                </tr>
                <tr>
                    <td>Total Tuber√≠a UTP (m)</td>
                    <td id="totalUTPConduit">0</td>
                </tr>
                <tr>
                    <td>Total Cableado AC (m)</td>
                    <td id="totalACCabling">0.0</td>
                </tr>
                <tr>
                    <td>Total Tuber√≠a AC (m)</td>
                    <td id="totalACConduit">0</td>
                </tr>
                <tr>
                    <td>Total Tuber√≠a (UTP + AC) (m)</td>
                    <td id="totalConduit">0</td>
                </tr>
            </table>
        </div>
        
        <div class="tab-content" id="export">
            <div class="section-title">Opciones de Exportaci√≥n</div>
            <div class="btn-group">
                <button id="exportExcel">Exportar a Excel</button>
                <button id="exportKMZ">Exportar a KMZ</button>
            </div>
            <div class="btn-group">
                <button id="exportWithImages" class="btn-success">Exportar Excel + Im√°genes</button>
                <button id="exportReport">Generar Reporte PDF</button>
            </div>
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">
        Listo para comenzar. Configure los nodos y agregue dispositivos al mapa.
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Variables globales
        let map;
        let devices = [];
        let routes = [];
        let nodes = [];
        let nextDeviceId = 1;
        let nextRouteId = 1;
        let currentRoute = null;
        let isDrawingRoute = false;
        let routePoints = [];
        let routePolyline = null;
        let deviceMarkers = {};
        let routeMarkers = {};
        
        // Colores para nodos
        const nodeColors = [
            '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
            '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50'
        ];
        
        // Tipos de dispositivos
        const deviceTypes = {
            camera: { label: 'C√°mara', icon: 'üìπ' },
            switch: { label: 'Switch', icon: 'üîå' },
            speaker: { label: 'Parlante IP', icon: 'üîä' },
            monitor: { label: 'Monitor/NVR', icon: 'üñ•Ô∏è' },
            antenna: { label: 'Antena', icon: 'üì°' },
            solar: { label: 'Panel Solar', icon: '‚òÄÔ∏è' }
        };
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            setupEventListeners();
            updateStatus('Sistema inicializado. Configure los nodos para comenzar.');
        });
        
        // Inicializar mapa
        function initMap() {
            map = L.map('map').setView([4.6097, -74.0817], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            map.on('click', handleMapClick);
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Actualizar tabs activos
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar contenido activo
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Generar nodos
            document.getElementById('generateNodes').addEventListener('click', generateNodes);
            
            // Agregar dispositivos
            document.getElementById('addDeviceByClick').addEventListener('click', function() {
                updateStatus('Haga clic en el mapa para agregar un dispositivo.');
                map._container.style.cursor = 'crosshair';
                map.once('click', function(e) {
                    map._container.style.cursor = '';
                    addDeviceAtLocation(e.latlng.lat, e.latlng.lng);
                });
            });
            
            document.getElementById('addDeviceByLocation').addEventListener('click', function() {
                if (!navigator.geolocation) {
                    updateStatus('Su navegador no soporta geolocalizaci√≥n.', 'error');
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 16);
                        addDeviceAtLocation(lat, lng);
                    },
                    error => {
                        updateStatus('No se pudo obtener su ubicaci√≥n actual.', 'error');
                    }
                );
            });
            
            // Rutas
            document.getElementById('startRoute').addEventListener('click', toggleRouteDrawing);
            document.getElementById('deleteLastRoute').addEventListener('click', deleteLastRoute);
            
            // Proyecto
            document.getElementById('saveProject').addEventListener('click', saveProject);
            document.getElementById('loadProject').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', function(e) {
                loadProject(e.target.files[0]);
            });
            
            // Exportaci√≥n
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportKMZ').addEventListener('click', exportToKMZ);
            document.getElementById('exportWithImages').addEventListener('click', exportWithImages);
            document.getElementById('exportReport').addEventListener('click', generatePDFReport);
        }
        
        // Generar nodos
        function generateNodes() {
            const numNodes = parseInt(document.getElementById('numNodes').value) || 1;
            nodes = [];
            
            for (let i = 0; i < numNodes; i++) {
                const letter = String.fromCharCode(65 + i); // A, B, C, etc.
                nodes.push({
                    id: i,
                    name: `Nodo ${i + 1}`,
                    letter: letter,
                    color: nodeColors[i % nodeColors.length],
                    cameras: 0,
                    switches: 0,
                    devices: []
                });
            }
            
            renderNodesList();
            updateDeviceNodeOptions();
            document.getElementById('nodesContainer').classList.remove('hidden');
            updateStatus(`Se han generado ${numNodes} nodos. Ahora puede agregar dispositivos al mapa.`);
            updateSummary();
        }
        
        // Renderizar lista de nodos
        function renderNodesList() {
            const nodesList = document.getElementById('nodesList');
            nodesList.innerHTML = '';
            
            nodes.forEach(node => {
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'node-marker';
                nodeDiv.innerHTML = `
                    <div class="node-color" style="background-color: ${node.color};"></div>
                    <div>
                        <strong>${node.name} (${node.letter})</strong>
                        <div>C√°maras: ${node.cameras} | Switches: ${node.switches}</div>
                    </div>
                `;
                nodesList.appendChild(nodeDiv);
            });
        }
        
        // Actualizar opciones de nodos en dispositivos
        function updateDeviceNodeOptions() {
            const deviceNodeSelect = document.getElementById('deviceNode');
            deviceNodeSelect.innerHTML = '<option value="">Sin asignar</option>';
            
            nodes.forEach(node => {
                const option = document.createElement('option');
                option.value = node.id;
                option.textContent = `${node.name} (${node.letter})`;
                deviceNodeSelect.appendChild(option);
            });
        }
        
        // Manejar clic en el mapa
        function handleMapClick(e) {
            if (isDrawingRoute) {
                addRoutePoint(e.latlng);
            }
        }
        
        // Agregar dispositivo en ubicaci√≥n espec√≠fica
        function addDeviceAtLocation(lat, lng) {
            const type = document.getElementById('deviceType').value;
            const nodeId = document.getElementById('deviceNode').value;
            const node = nodeId ? nodes.find(n => n.id == nodeId) : null;
            
            // Generar nombre basado en tipo y nodo
            let name = '';
            if (node) {
                if (type === 'camera') {
                    node.cameras++;
                    name = `${node.letter}${node.cameras}`;
                } else if (type === 'switch') {
                    node.switches++;
                    name = `${node.letter}SW${node.switches}`;
                } else {
                    name = `${node.letter}${deviceTypes[type].label.substring(0, 3)}${node.devices.length + 1}`;
                }
                node.devices.push(nextDeviceId);
            } else {
                name = `${deviceTypes[type].label.substring(0, 3)}${nextDeviceId}`;
            }
            
            const device = {
                id: nextDeviceId++,
                type: type,
                name: name,
                nodeId: nodeId,
                lat: lat,
                lng: lng,
                comments: '',
                image1: null,
                image2: null
            };
            
            devices.push(device);
            
            // Agregar marcador al mapa
            const icon = L.divIcon({
                html: `<div style="background-color: ${node ? node.color : '#777'}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">${deviceTypes[type].icon}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([lat, lng], { icon: icon, draggable: true }).addTo(map);
            
            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                device.lat = position.lat;
                device.lng = position.lng;
                updateDevicesList();
                updateDevicesTable();
                calculateMaterials();
            });
            
            marker.bindPopup(`
                <div>
                    <strong>${name}</strong><br>
                    Tipo: ${deviceTypes[type].label}<br>
                    Nodo: ${node ? node.name : 'Sin asignar'}<br>
                    <button onclick="editDevice(${device.id})">Editar</button>
                    <button onclick="deleteDevice(${device.id})">Eliminar</button>
                </div>
            `);
            
            deviceMarkers[device.id] = marker;
            
            renderNodesList();
            updateDevicesList();
            updateDevicesTable();
            updateSummary();
            calculateMaterials();
            updateStatus(`Dispositivo "${name}" agregado al mapa.`);
        }
        
        // Editar dispositivo
        function editDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            const newComments = prompt('Comentarios del dispositivo:', device.comments);
            if (newComments !== null) {
                device.comments = newComments;
                updateDevicesList();
                updateDevicesTable();
                updateStatus(`Dispositivo "${device.name}" actualizado.`);
            }
        }
        
        // Eliminar dispositivo
        function deleteDevice(deviceId) {
            const deviceIndex = devices.findIndex(d => d.id === deviceId);
            if (deviceIndex === -1) return;
            
            const device = devices[deviceIndex];
            
            // Eliminar del nodo si est√° asignado
            if (device.nodeId) {
                const node = nodes.find(n => n.id == device.nodeId);
                if (node) {
                    if (device.type === 'camera') node.cameras--;
                    else if (device.type === 'switch') node.switches--;
                    
                    const deviceIndexInNode = node.devices.indexOf(deviceId);
                    if (deviceIndexInNode !== -1) node.devices.splice(deviceIndexInNode, 1);
                }
            }
            
            // Eliminar del mapa
            if (deviceMarkers[deviceId]) {
                map.removeLayer(deviceMarkers[deviceId]);
                delete deviceMarkers[deviceId];
            }
            
            // Eliminar del array
            devices.splice(deviceIndex, 1);
            
            renderNodesList();
            updateDevicesList();
            updateDevicesTable();
            updateSummary();
            calculateMaterials();
            updateStatus(`Dispositivo "${device.name}" eliminado.`);
        }
        
        // Capturar imagen para un dispositivo
        function captureImage(deviceId, imageSlot) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Para abrir la c√°mara en m√≥viles
            input.onchange = (e) => {
                const file = e.target.files?.[0];
                if (!file || !file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    device[imageSlot] = ev.target.result;
                    updateDevicesTable();
                    updateStatus(`üì∑ Imagen ${imageSlot === 'image1' ? '1' : '2'} guardada para ${device.name}.`);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // Actualizar lista de dispositivos
        function updateDevicesList() {
            const devicesList = document.getElementById('devicesList');
            
            if (devices.length === 0) {
                devicesList.innerHTML = '<p>No hay dispositivos agregados</p>';
                return;
            }
            
            devicesList.innerHTML = '';
            
            devices.forEach(device => {
                const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-item';
                deviceDiv.innerHTML = `
                    <div>
                        <strong>${device.name}</strong>
                        <div>${deviceTypes[device.type].label} ${node ? `(${node.name})` : ''}</div>
                    </div>
                    <button onclick="deleteDevice(${device.id})" class="btn-danger" style="width: auto; padding: 5px 10px;">Eliminar</button>
                `;
                devicesList.appendChild(deviceDiv);
            });
        }
        
        // Actualizar tabla de dispositivos
        function updateDevicesTable() {
            const tableBody = document.getElementById('devicesTableBody');
            
            if (devices.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8">No hay dispositivos agregados</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            devices.forEach(device => {
                const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${device.id}</td>
                    <td>${deviceTypes[device.type].label}</td>
                    <td>${device.name}</td>
                    <td>${node ? node.name : 'Sin asignar'}</td>
                    <td>${device.comments || '-'}</td>
                    <td>${device.image1 ? `<img src="${device.image1}" class="thumb">` : '‚Äî'}</td>
                    <td>${device.image2 ? `<img src="${device.image2}" class="thumb">` : '‚Äî'}</td>
                    <td>
                        <div class="action-btn-group">
                            <button onclick="captureImage(${device.id}, 'image1')">üì∑ Img1</button>
                            <button onclick="captureImage(${device.id}, 'image2')">üì∑ Img2</button>
                            <button onclick="editDevice(${device.id})" class="btn-warning">Editar</button>
                            <button onclick="deleteDevice(${device.id})" class="btn-danger">Eliminar</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Iniciar/detener dibujo de ruta
        function toggleRouteDrawing() {
            const button = document.getElementById('startRoute');
            
            if (isDrawingRoute) {
                // Finalizar ruta
                if (routePoints.length < 2) {
                    updateStatus('Una ruta debe tener al menos 2 puntos.', 'error');
                    return;
                }
                
                finishRoute();
                isDrawingRoute = false;
                button.textContent = 'Iniciar Ruta';
                button.classList.remove('btn-danger');
                map._container.style.cursor = '';
                updateStatus('Ruta finalizada.');
            } else {
                // Iniciar ruta
                isDrawingRoute = true;
                routePoints = [];
                button.textContent = 'Finalizar Ruta';
                button.classList.add('btn-danger');
                map._container.style.cursor = 'crosshair';
                updateStatus('Haga clic en el mapa para dibujar una ruta.');
            }
        }
        
        // Agregar punto a la ruta
        function addRoutePoint(latlng) {
            routePoints.push(latlng);
            
            // Actualizar polil√≠nea
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            routePolyline = L.polyline(routePoints, {
                color: '#ff5722',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(map);
            
            updateStatus(`Punto ${routePoints.length} agregado a la ruta.`);
        }
        
        // Finalizar ruta
        function finishRoute() {
            // Calcular distancia total
            let totalDistance = 0;
            for (let i = 0; i < routePoints.length - 1; i++) {
                totalDistance += routePoints[i].distanceTo(routePoints[i + 1]);
            }
            
            // Encontrar dispositivos cercanos al inicio y fin de la ruta
            const startPoint = routePoints[0];
            const endPoint = routePoints[routePoints.length - 1];
            
            const startDevice = findNearestDevice(startPoint);
            const endDevice = findNearestDevice(endPoint);
            
            // Generar nombre de ruta
            let routeName = `Ruta ${nextRouteId}`;
            if (startDevice && endDevice) {
                routeName = `${startDevice.name} - ${endDevice.name}`;
            } else if (startDevice) {
                routeName = `${startDevice.name} - Punto final`;
            } else if (endDevice) {
                routeName = `Punto inicial - ${endDevice.name}`;
            }
            
            // Crear objeto de ruta
            const route = {
                id: nextRouteId++,
                name: routeName,
                points: routePoints.map(p => ({ lat: p.lat, lng: p.lng })),
                distance: totalDistance,
                startDevice: startDevice ? startDevice.id : null,
                endDevice: endDevice ? endDevice.id : null
            };
            
            routes.push(route);
            
            // Reemplazar polil√≠nea temporal con la definitiva
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            routePolyline = L.polyline(routePoints, {
                color: '#ff5722',
                weight: 3,
                opacity: 0.7
            }).addTo(map);
            
            // Agregar marcador de distancia en el punto medio
            const midPoint = routePoints[Math.floor(routePoints.length / 2)];
            const distanceMarker = L.marker(midPoint, {
                icon: L.divIcon({
                    className: 'distance-marker',
                    html: `<div style="background-color: #ff5722; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 0 5px rgba(0,0,0,0.5);">${Math.round(totalDistance)} m</div>`,
                    iconSize: [80, 20],
                    iconAnchor: [40, 10]
                })
            }).addTo(map);
            
            // Guardar referencia a los marcadores
            routeMarkers[route.id] = {
                polyline: routePolyline,
                distanceMarker: distanceMarker
            };
            
            // Limpiar variables temporales
            routePoints = [];
            routePolyline = null;
            
            updateRoutesList();
            updateRoutesTable();
            updateSummary();
            calculateMaterials();
        }
        
        // Encontrar dispositivo m√°s cercano a un punto
        function findNearestDevice(point) {
            let nearestDevice = null;
            let minDistance = Infinity;
            
            devices.forEach(device => {
                const deviceLatLng = L.latLng(device.lat, device.lng);
                const distance = point.distanceTo(deviceLatLng);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestDevice = device;
                }
            });
            
            // Solo considerar como cercano si est√° a menos de 50 metros
            return minDistance < 50 ? nearestDevice : null;
        }
        
        // Eliminar √∫ltima ruta
        function deleteLastRoute() {
            if (routes.length === 0) {
                updateStatus('No hay rutas para eliminar.', 'error');
                return;
            }
            
            const lastRoute = routes.pop();
            
            // Eliminar del mapa
            if (routeMarkers[lastRoute.id]) {
                map.removeLayer(routeMarkers[lastRoute.id].polyline);
                map.removeLayer(routeMarkers[lastRoute.id].distanceMarker);
                delete routeMarkers[lastRoute.id];
            }
            
            updateRoutesList();
            updateRoutesTable();
            updateSummary();
            calculateMaterials();
            updateStatus(`Ruta "${lastRoute.name}" eliminada.`);
        }
        
        // Actualizar lista de rutas
        function updateRoutesList() {
            const routesList = document.getElementById('routesList');
            
            if (routes.length === 0) {
                routesList.innerHTML = '<p>No hay rutas definidas</p>';
                return;
            }
            
            routesList.innerHTML = '';
            
            routes.forEach(route => {
                const routeDiv = document.createElement('div');
                routeDiv.className = 'device-item';
                routeDiv.innerHTML = `
                    <div>
                        <strong>${route.name}</strong>
                        <div>Distancia: ${Math.round(route.distance)} m</div>
                    </div>
                    <button onclick="zoomToRoute(${route.id})" style="width: auto; padding: 5px 10px;">Ver</button>
                `;
                routesList.appendChild(routeDiv);
            });
        }
        
        // Actualizar tabla de rutas
        function updateRoutesTable() {
            const tableBody = document.getElementById('routesTableBody');
            
            if (routes.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No hay rutas definidas</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            routes.forEach(route => {
                const startDevice = route.startDevice ? devices.find(d => d.id === route.startDevice) : null;
                const endDevice = route.endDevice ? devices.find(d => d.id === route.endDevice) : null;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${route.id}</td>
                    <td>${route.name}</td>
                    <td>${startDevice ? startDevice.name : 'Punto inicial'}</td>
                    <td>${endDevice ? endDevice.name : 'Punto final'}</td>
                    <td>${Math.round(route.distance)}</td>
                    <td>
                        <button onclick="zoomToRoute(${route.id})" style="width: auto; padding: 5px 10px;">Ver</button>
                        <button onclick="deleteRoute(${route.id})" class="btn-danger" style="width: auto; padding: 5px 10px;">Eliminar</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Hacer zoom a una ruta
        function zoomToRoute(routeId) {
            const route = routes.find(r => r.id === routeId);
            if (!route) return;
            
            const latlngs = route.points.map(p => L.latLng(p.lat, p.lng));
            const bounds = L.latLngBounds(latlngs);
            map.fitBounds(bounds, { padding: [50, 50] });
            
            updateStatus(`Mostrando ruta "${route.name}".`);
        }
        
        // Eliminar una ruta espec√≠fica
        function deleteRoute(routeId) {
            const routeIndex = routes.findIndex(r => r.id === routeId);
            if (routeIndex === -1) return;
            
            const route = routes[routeIndex];
            
            // Eliminar del mapa
            if (routeMarkers[routeId]) {
                map.removeLayer(routeMarkers[routeId].polyline);
                map.removeLayer(routeMarkers[routeId].distanceMarker);
                delete routeMarkers[routeId];
            }
            
            // Eliminar del array
            routes.splice(routeIndex, 1);
            
            updateRoutesList();
            updateRoutesTable();
            updateSummary();
            calculateMaterials();
            updateStatus(`Ruta "${route.name}" eliminada.`);
        }
        
        // Actualizar resumen
        function updateSummary() {
            document.getElementById('totalNodes').textContent = nodes.length;
            document.getElementById('totalCameras').textContent = devices.filter(d => d.type === 'camera').length;
            document.getElementById('totalSwitches').textContent = devices.filter(d => d.type === 'switch').length;
            document.getElementById('totalOtherDevices').textContent = devices.filter(d => d.type !== 'camera' && d.type !== 'switch').length;
            document.getElementById('totalRoutes').textContent = routes.length;
            
            const totalRouteLength = routes.reduce((sum, route) => sum + route.distance, 0);
            document.getElementById('totalRouteLength').textContent = Math.round(totalRouteLength);
        }
        
        // Calcular materiales
        function calculateMaterials() {
            // Contar c√°maras y switches por nodo
            const nodeStats = {};
            
            nodes.forEach(node => {
                nodeStats[node.id] = {
                    cameras: 0,
                    switches: 0,
                    cableLengths: []
                };
            });
            
            devices.forEach(device => {
                if (device.nodeId && nodeStats[device.nodeId]) {
                    if (device.type === 'camera') {
                        nodeStats[device.nodeId].cameras++;
                    } else if (device.type === 'switch') {
                        nodeStats[device.nodeId].switches++;
                    }
                }
            });
            
            // Calcular longitudes de cable basadas en rutas
            routes.forEach(route => {
                if (route.startDevice && route.endDevice) {
                    const startDevice = devices.find(d => d.id === route.startDevice);
                    const endDevice = devices.find(d => d.id === route.endDevice);
                    
                    if (startDevice && endDevice) {
                        // Determinar si es una ruta UTP o AC
                        if ((startDevice.type === 'camera' && endDevice.type === 'switch') ||
                            (startDevice.type === 'switch' && endDevice.type === 'camera') ||
                            (startDevice.type === 'switch' && endDevice.type === 'switch')) {
                            // Es una ruta UTP
                            if (startDevice.nodeId && nodeStats[startDevice.nodeId]) {
                                nodeStats[startDevice.nodeId].cableLengths.push(route.distance);
                            }
                        } else {
                            // Es una ruta AC
                            // No la contamos aqu√≠, se a√±adir√° al total de AC
                        }
                    }
                }
            });
            
            // Calcular totales
            let totalUTPCables = 0;
            let utpCablingCameras = 0;
            let utpCablingNodes = 0;
            let totalUTPCabling = 0;
            let totalUTPConduit = 0;
            let totalACCabling = 0;
            let totalACConduit = 0;
            
            // Calcular cableado UTP para c√°maras
            const cameras = devices.filter(d => d.type === 'camera');
            cameras.forEach(camera => {
                // Estimaci√≥n de 50m por c√°mara si no hay ruta definida
                let cableLength = 50;
                
                // Buscar una ruta a un switch
                const connectedRoute = routes.find(r => 
                    (r.startDevice === camera.id && devices.find(d => d.id === r.endDevice && d.type === 'switch')) ||
                    (r.endDevice === camera.id && devices.find(d => d.id === r.startDevice && d.type === 'switch'))
                );
                
                if (connectedRoute) {
                    cableLength = connectedRoute.distance;
                }
                
                utpCablingCameras += cableLength;
            });
            
            // Calcular cableado UTP para nodos
            Object.values(nodeStats).forEach(stats => {
                // Cableado para switches
                if (stats.switches > 0) {
                    // Estimaci√≥n de 100m por switch si no hay ruta definida
                    let cableLength = 100;
                    
                    // Buscar rutas entre switches
                    const nodeSwitches = devices.filter(d => d.type === 'switch' && d.nodeId && nodeStats[d.nodeId] === stats);
                    
                    nodeSwitches.forEach(sw1 => {
                        nodeSwitches.forEach(sw2 => {
                            if (sw1.id < sw2.id) { // Evitar duplicados
                                const connectedRoute = routes.find(r => 
                                    (r.startDevice === sw1.id && r.endDevice === sw2.id) ||
                                    (r.startDevice === sw2.id && r.endDevice === sw1.id)
                                );
                                
                                if (connectedRoute) {
                                    cableLength += connectedRoute.distance;
                                } else {
                                    cableLength += 50; // Estimaci√≥n para conexi√≥n no definida
                                }
                            }
                        });
                    });
                    
                    utpCablingNodes += cableLength;
                }
            });
            
            // Calcular cableado AC
            devices.forEach(device => {
                // Estimaci√≥n de 30m por dispositivo para alimentaci√≥n AC
                totalACCabling += 30;
            });
            
            // A√±adir longitudes de rutas AC
            routes.forEach(route => {
                if (route.startDevice && route.endDevice) {
                    const startDevice = devices.find(d => d.id === route.startDevice);
                    const endDevice = devices.find(d => d.id === route.endDevice);
                    
                    if (startDevice && endDevice) {
                        // Determinar si es una ruta AC
                        if (!((startDevice.type === 'camera' && endDevice.type === 'switch') ||
                              (startDevice.type === 'switch' && endDevice.type === 'camera') ||
                              (startDevice.type === 'switch' && endDevice.type === 'switch'))) {
                            // Es una ruta AC
                            totalACCabling += route.distance;
                        }
                    }
                }
            });
            
            // Calcular totales
            totalUTPCables = cameras.length + devices.filter(d => d.type === 'switch').length;
            totalUTPCabling = utpCablingCameras + utpCablingNodes;
            
            // Calcular tuber√≠a (90% del cableado)
            totalUTPConduit = Math.round(totalUTPCabling * 0.9);
            totalACConduit = Math.round(totalACCabling * 0.9);
            
            // Actualizar UI
            document.getElementById('totalUTPCables').textContent = totalUTPCables;
            document.getElementById('utpCablingCameras').textContent = utpCablingCameras.toFixed(1);
            document.getElementById('utpCablingNodes').textContent = utpCablingNodes.toFixed(1);
            document.getElementById('totalUTPCabling').textContent = totalUTPCabling.toFixed(1);
            document.getElementById('totalUTPConduit').textContent = totalUTPConduit;
            document.getElementById('totalACCabling').textContent = totalACCabling.toFixed(1);
            document.getElementById('totalACConduit').textContent = totalACConduit;
            document.getElementById('totalConduit').textContent = totalUTPConduit + totalACConduit;
        }
        
        // Guardar proyecto
        function saveProject() {
            const projectName = document.getElementById('projectName').value || 'Proyecto CCTV';
            const projectNotes = document.getElementById('projectNotes').value || '';
            
            const project = {
                name: projectName,
                notes: projectNotes,
                nodes: nodes,
                devices: devices.map(d => ({ ...d, image1: null, image2: null })), // No guardar im√°genes en JSON
                routes: routes.map(route => ({
                    ...route,
                    points: route.points.map(p => ({ lat: p.lat, lng: p.lng }))
                })),
                metadata: {
                    version: '1.0',
                    created: new Date().toISOString(),
                    nextDeviceId: nextDeviceId,
                    nextRouteId: nextRouteId
                }
            };
            
            const dataStr = JSON.stringify(project, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            saveAs(dataBlob, `${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.json`);
            
            updateStatus(`Proyecto "${projectName}" guardado correctamente.`);
        }
        
        // Cargar proyecto
        function loadProject(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const project = JSON.parse(e.target.result);
                    
                    // Limpiar estado actual
                    clearProject();
                    
                    // Cargar datos del proyecto
                    document.getElementById('projectName').value = project.name || '';
                    document.getElementById('projectNotes').value = project.notes || '';
                    
                    nodes = project.nodes || [];
                    devices = project.devices || [];
                    routes = project.routes || [];
                    
                    if (project.metadata) {
                        nextDeviceId = project.metadata.nextDeviceId || 1;
                        nextRouteId = project.metadata.nextRouteId || 1;
                    }
                    
                    // Recrear nodos en el mapa
                    renderNodesList();
                    updateDeviceNodeOptions();
                    
                    // Recrear dispositivos en el mapa
                    devices.forEach(device => {
                        const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                        
                        const icon = L.divIcon({
                            html: `<div style="background-color: ${node ? node.color : '#777'}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);">${deviceTypes[device.type].icon}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const marker = L.marker([device.lat, device.lng], { icon: icon, draggable: true }).addTo(map);
                        
                        marker.on('dragend', function(e) {
                            const position = marker.getLatLng();
                            device.lat = position.lat;
                            device.lng = position.lng;
                            updateDevicesList();
                            updateDevicesTable();
                            calculateMaterials();
                        });
                        
                        marker.bindPopup(`
                            <div>
                                <strong>${device.name}</strong><br>
                                Tipo: ${deviceTypes[device.type].label}<br>
                                Nodo: ${node ? node.name : 'Sin asignar'}<br>
                                <button onclick="editDevice(${device.id})">Editar</button>
                                <button onclick="deleteDevice(${device.id})">Eliminar</button>
                            </div>
                        `);
                        
                        deviceMarkers[device.id] = marker;
                    });
                    
                    // Recrear rutas en el mapa
                    routes.forEach(route => {
                        const latlngs = route.points.map(p => L.latLng(p.lat, p.lng));
                        
                        const polyline = L.polyline(latlngs, {
                            color: '#ff5722',
                            weight: 3,
                            opacity: 0.7
                        }).addTo(map);
                        
                        // Agregar marcador de distancia en el punto medio
                        const midPoint = latlngs[Math.floor(latlngs.length / 2)];
                        const distanceMarker = L.marker(midPoint, {
                            icon: L.divIcon({
                                className: 'distance-marker',
                                html: `<div style="background-color: #ff5722; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 0 5px rgba(0,0,0,0.5);">${Math.round(route.distance)} m</div>`,
                                iconSize: [80, 20],
                                iconAnchor: [40, 10]
                            })
                        }).addTo(map);
                        
                        // Guardar referencia a los marcadores
                        routeMarkers[route.id] = {
                            polyline: polyline,
                            distanceMarker: distanceMarker
                        };
                    });
                    
                    // Actualizar UI
                    updateDevicesList();
                    updateDevicesTable();
                    updateRoutesList();
                    updateRoutesTable();
                    updateSummary();
                    calculateMaterials();
                    
                    // Mostrar contenedor de nodos si hay nodos
                    if (nodes.length > 0) {
                        document.getElementById('nodesContainer').classList.remove('hidden');
                        document.getElementById('numNodes').value = nodes.length;
                    }
                    
                    updateStatus(`Proyecto "${project.name}" cargado correctamente.`);
                } catch (error) {
                    console.error('Error al cargar el proyecto:', error);
                    updateStatus('Error al cargar el proyecto. El archivo podr√≠a estar da√±ado.', 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Limpiar proyecto actual
        function clearProject() {
            // Limpiar mapa
            Object.values(deviceMarkers).forEach(marker => {
                map.removeLayer(marker);
            });
            deviceMarkers = {};
            
            Object.values(routeMarkers).forEach(markers => {
                map.removeLayer(markers.polyline);
                map.removeLayer(markers.distanceMarker);
            });
            routeMarkers = {};
            
            // Limpiar variables
            devices = [];
            routes = [];
            nodes = [];
            nextDeviceId = 1;
            nextRouteId = 1;
            currentRoute = null;
            isDrawingRoute = false;
            routePoints = [];
            routePolyline = null;
            
            // Limpiar UI
            document.getElementById('nodesContainer').classList.add('hidden');
            document.getElementById('projectName').value = '';
            document.getElementById('projectNotes').value = '';
            
            updateDevicesList();
            updateDevicesTable();
            updateRoutesList();
            updateRoutesTable();
            updateSummary();
            calculateMaterials();
        }
        
        // Convertir DataURL a Blob
        function dataURLtoBlob(dataurl) {
            const arr = dataurl.split(',');
            const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]);
            let n = bstr.length;
            const u8arr = new Uint8Array(n);
            while(n--) u8arr[n] = bstr.charCodeAt(n);
            return new Blob([u8arr], { type: mime });
        }

        // Exportar a Excel con im√°genes
        function exportWithImages() {
            const projectName = document.getElementById('projectName').value || 'Proyecto_CCTV';
            const zip = new JSZip();
            const imgFolder = zip.folder("imagenes");

            const deviceDataForExcel = devices.map(device => {
                const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                let img1Path = '';
                let img2Path = '';

                if (device.image1) {
                    const filename1 = `${device.name.replace(/[^a-z0-9]/gi, '_')}_Img1.jpg`;
                    imgFolder.file(filename1, dataURLtoBlob(device.image1));
                    img1Path = `imagenes/${filename1}`;
                }
                if (device.image2) {
                    const filename2 = `${device.name.replace(/[^a-z0-9]/gi, '_')}_Img2.jpg`;
                    imgFolder.file(filename2, dataURLtoBlob(device.image2));
                    img2Path = `imagenes/${filename2}`;
                }

                return {
                    ID: device.id,
                    Nombre: device.name,
                    Tipo: deviceTypes[device.type].label,
                    Nodo: node ? node.name : 'Sin asignar',
                    Latitud: device.lat.toFixed(6),
                    Longitud: device.lng.toFixed(6),
                    Comentarios: device.comments || '',
                    'Ruta Imagen 1': img1Path,
                    'Ruta Imagen 2': img2Path
                };
            });

            const ws = XLSX.utils.json_to_sheet(deviceDataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dispositivos");

            if (routes.length > 0) {
                const routeSheet = XLSX.utils.json_to_sheet(routes.map(r => {
                    const startDevice = r.startDevice ? devices.find(d => d.id === r.startDevice) : null;
                    const endDevice = r.endDevice ? devices.find(d => d.id === r.endDevice) : null;
                    return {
                        'ID Ruta': r.id,
                        'Nombre': r.name,
                        'Origen': startDevice ? startDevice.name : 'Punto inicial',
                        'Destino': endDevice ? endDevice.name : 'Punto final',
                        'Distancia (m)': Math.round(r.distance)
                    };
                }));
                XLSX.utils.book_append_sheet(wb, routeSheet, "Rutas");
            }

            const summaryData = [
                ['Concepto', 'Valor'],
                ['Nombre del Proyecto', document.getElementById('projectName').value || 'N/A'],
                ['Total de Nodos', nodes.length],
                ['Total de C√°maras', devices.filter(d => d.type === 'camera').length],
                ['Total de Switches', devices.filter(d => d.type === 'switch').length],
                ['Total de Rutas', routes.length],
                ['Longitud Total de Rutas (m)', Math.round(routes.reduce((sum, route) => sum + route.distance, 0))],
                ['Total Cableado UTP (m)', document.getElementById('totalUTPCabling').textContent],
                ['Total Tuber√≠a UTP (m)', document.getElementById('totalUTPConduit').textContent],
                ['Total Cableado AC (m)', document.getElementById('totalACCabling').textContent],
                ['Total Tuber√≠a AC (m)', document.getElementById('totalACConduit').textContent],
                ['Total Tuber√≠a (UTP + AC) (m)', document.getElementById('totalConduit').textContent]
            ];
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, "Resumen");

            const notesData = [['Notas del Proyecto'], [document.getElementById('projectNotes').value || 'Sin notas']];
            const notesWs = XLSX.utils.aoa_to_sheet(notesData);
            XLSX.utils.book_append_sheet(wb, notesWs, "Notas");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            zip.file("Reporte_MAST.xlsx", wbout, { binary: true });

            zip.generateAsync({ type: "blob" }).then(blob => {
                saveAs(blob, `${projectName.replace(/\s+/g, '_')}_Con_Imagenes.zip`);
                updateStatus("‚úÖ Excel + im√°genes exportados en ZIP.");
            }).catch(err => {
                console.error(err);
                updateStatus("‚ùå Error al generar el ZIP.", 'error');
            });
        }
        
        // Exportar a Excel (simplificado, sin im√°genes)
        function exportToExcel() {
            const projectName = document.getElementById('projectName').value || 'Proyecto_CCTV';
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            
            // Hoja de resumen
            const summaryData = [
                ['Concepto', 'Valor'],
                ['Nombre del Proyecto', projectName],
                ['Total de Nodos', nodes.length],
                ['Total de C√°maras', devices.filter(d => d.type === 'camera').length],
                ['Total de Switches', devices.filter(d => d.type === 'switch').length],
                ['Total de Otros Dispositivos', devices.filter(d => d.type !== 'camera' && d.type !== 'switch').length],
                ['Total de Rutas', routes.length],
                ['Longitud Total de Rutas (m)', Math.round(routes.reduce((sum, route) => sum + route.distance, 0))],
                ['Total de Cables UTP', document.getElementById('totalUTPCables').textContent],
                ['Total Cableado UTP (m)', document.getElementById('totalUTPCabling').textContent],
                ['Total Tuber√≠a UTP (m)', document.getElementById('totalUTPConduit').textContent],
                ['Total Cableado AC (m)', document.getElementById('totalACCabling').textContent],
                ['Total Tuber√≠a AC (m)', document.getElementById('totalACConduit').textContent],
                ['Total Tuber√≠a (UTP + AC) (m)', document.getElementById('totalConduit').textContent]
            ];
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Resumen');
            
            // Hoja de dispositivos
            if (devices.length > 0) {
                const devicesData = [
                    ['ID', 'Nombre', 'Tipo', 'Nodo', 'Latitud', 'Longitud', 'Comentarios']
                ];
                
                devices.forEach(device => {
                    const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                    devicesData.push([
                        device.id,
                        device.name,
                        deviceTypes[device.type].label,
                        node ? node.name : 'Sin asignar',
                        device.lat.toFixed(6),
                        device.lng.toFixed(6),
                        device.comments || ''
                    ]);
                });
                
                const devicesWs = XLSX.utils.aoa_to_sheet(devicesData);
                XLSX.utils.book_append_sheet(wb, devicesWs, 'Dispositivos');
            }
            
            // Hoja de rutas
            if (routes.length > 0) {
                const routesData = [
                    ['ID', 'Nombre', 'Origen', 'Destino', 'Distancia (m)']
                ];
                
                routes.forEach(route => {
                    const startDevice = route.startDevice ? devices.find(d => d.id === route.startDevice) : null;
                    const endDevice = route.endDevice ? devices.find(d => d.id === route.endDevice) : null;
                    
                    routesData.push([
                        route.id,
                        route.name,
                        startDevice ? startDevice.name : 'Punto inicial',
                        endDevice ? endDevice.name : 'Punto final',
                        Math.round(route.distance)
                    ]);
                });
                
                const routesWs = XLSX.utils.aoa_to_sheet(routesData);
                XLSX.utils.book_append_sheet(wb, routesWs, 'Rutas');
            }
            
            // Hoja de nodos
            if (nodes.length > 0) {
                const nodesData = [
                    ['ID', 'Nombre', 'Letra', 'C√°maras', 'Switches', 'Total Dispositivos']
                ];
                
                nodes.forEach(node => {
                    nodesData.push([
                        node.id,
                        node.name,
                        node.letter,
                        node.cameras,
                        node.switches,
                        node.devices.length
                    ]);
                });
                
                const nodesWs = XLSX.utils.aoa_to_sheet(nodesData);
                XLSX.utils.book_append_sheet(wb, nodesWs, 'Nodos');
            }
            
            // Hoja de notas
            const notesData = [
                ['Notas del Proyecto'],
                [document.getElementById('projectNotes').value || 'Sin notas']
            ];
            
            const notesWs = XLSX.utils.aoa_to_sheet(notesData);
            XLSX.utils.book_append_sheet(wb, notesWs, 'Notas');
            
            // Guardar archivo
            XLSX.writeFile(wb, `${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`);
            
            updateStatus('Proyecto exportado a Excel correctamente.');
        }
        
        // Exportar a KMZ
        function exportToKMZ() {
            const projectName = document.getElementById('projectName').value || 'Proyecto CCTV';
            
            // Crear contenido KML
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
            <kml xmlns="http://www.opengis.net/kml/2.2">
                <Document>
                    <name>${projectName}</name>
                    <description>${document.getElementById('projectNotes').value || 'Proyecto CCTV'}</description>`;
            
            // Agregar dispositivos como marcadores
            devices.forEach(device => {
                const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                let desc = `<strong>${device.name}</strong><br>Tipo: ${deviceTypes[device.type].label}<br>Nodo: ${node ? node.name : 'Sin asignar'}<br>Comentarios: ${device.comments || 'N/A'}`;
                if (device.image1) desc += `<br><img src="${device.image1}" width="200">`;
                if (device.image2) desc += `<br><img src="${device.image2}" width="200">`;

                kmlContent += `
                    <Placemark>
                        <name>${device.name}</name>
                        <description><![CDATA[${desc}]]></description>
                        <styleUrl>#${device.type}-style</styleUrl>
                        <Point>
                            <coordinates>${device.lng},${device.lat},0</coordinates>
                        </Point>
                    </Placemark>`;
            });
            
            // Agregar rutas como l√≠neas
            routes.forEach(route => {
                const startDevice = route.startDevice ? devices.find(d => d.id === route.startDevice) : null;
                const endDevice = route.endDevice ? devices.find(d => d.id === route.endDevice) : null;
                
                kmlContent += `
                    <Placemark>
                        <name>${route.name}</name>
                        <description>
                            <![CDATA[
                                <strong>Distancia:</strong> ${Math.round(route.distance)} m<br>
                                <strong>Origen:</strong> ${startDevice ? startDevice.name : 'Punto inicial'}<br>
                                <strong>Destino:</strong> ${endDevice ? endDevice.name : 'Punto final'}
                            ]]>
                        </description>
                        <LineString>
                            <coordinates>
                                ${route.points.map(p => `${p.lng},${p.lat},0`).join('\n                                ')}
                            </coordinates>
                        </LineString>
                    </Placemark>`;
            });
            
            // Agregar estilos para los diferentes tipos de dispositivos
            kmlContent += `
                <Style id="camera-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon57.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
                <Style id="switch-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon27.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
                <Style id="speaker-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon28.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
                <Style id="monitor-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon29.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
                <Style id="antenna-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon30.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
                <Style id="solar-style">
                    <IconStyle>
                        <Icon>
                            <href>https://maps.google.com/mapfiles/kml/pal4/icon31.png</href>
                        </Icon>
                    </IconStyle>
                </Style>
            </Document>
        </kml>`;
            
            // Crear archivo ZIP con el KML
            const zip = new JSZip();
            zip.file('doc.kml', kmlContent);
            
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                saveAs(content, `${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.kmz`);
                updateStatus('Proyecto exportado a KMZ correctamente.');
            });
        }
        
        // Generar reporte PDF
        function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const projectName = document.getElementById('projectName').value || 'Proyecto CCTV';
            
            // Crear documento PDF
            const doc = new jsPDF();
            
            // Configurar fuentes
            doc.setFont('helvetica');
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text(projectName, 105, 20, { align: 'center' });
            
            // Fecha
            doc.setFontSize(10);
            doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Resumen
            doc.setFontSize(14);
            doc.text('Resumen del Proyecto', 20, 45);
            
            doc.setFontSize(10);
            let yPosition = 55;
            
            doc.text(`Total de Nodos: ${nodes.length}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total de C√°maras: ${devices.filter(d => d.type === 'camera').length}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total de Switches: ${devices.filter(d => d.type === 'switch').length}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total de Otros Dispositivos: ${devices.filter(d => d.type !== 'camera' && d.type !== 'switch').length}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total de Rutas: ${routes.length}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Longitud Total de Rutas: ${Math.round(routes.reduce((sum, route) => sum + route.distance, 0))} m`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total de Cables UTP: ${document.getElementById('totalUTPCables').textContent}`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total Cableado UTP: ${document.getElementById('totalUTPCabling').textContent} m`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total Tuber√≠a UTP: ${document.getElementById('totalUTPConduit').textContent} m`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total Cableado AC: ${document.getElementById('totalACCabling').textContent} m`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total Tuber√≠a AC: ${document.getElementById('totalACConduit').textContent} m`, 20, yPosition);
            yPosition += 7;
            
            doc.text(`Total Tuber√≠a (UTP + AC): ${document.getElementById('totalConduit').textContent} m`, 20, yPosition);
            yPosition += 15;
            
            // Dispositivos
            if (devices.length > 0) {
                doc.setFontSize(14);
                doc.text('Dispositivos', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                devices.forEach(device => {
                    const node = device.nodeId ? nodes.find(n => n.id == device.nodeId) : null;
                    
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(`${device.name} - ${deviceTypes[device.type].label} ${node ? `(${node.name})` : ''}`, 20, yPosition);
                    yPosition += 5;
                    
                    doc.text(`  Lat: ${device.lat.toFixed(6)}, Lng: ${device.lng.toFixed(6)}`, 25, yPosition);
                    yPosition += 7;
                });
            }
            
            // Rutas
            if (routes.length > 0) {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.text('Rutas', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                routes.forEach(route => {
                    const startDevice = route.startDevice ? devices.find(d => d.id === route.startDevice) : null;
                    const endDevice = route.endDevice ? devices.find(d => d.id === route.endDevice) : null;
                    
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(`${route.name}: ${Math.round(route.distance)} m`, 20, yPosition);
                    yPosition += 5;
                    
                    doc.text(`  De: ${startDevice ? startDevice.name : 'Punto inicial'} a ${endDevice ? endDevice.name : 'Punto final'}`, 25, yPosition);
                    yPosition += 7;
                });
            }
            
            // Notas
            const notes = document.getElementById('projectNotes').value;
            if (notes) {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(14);
                doc.text('Notas del Proyecto', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(10);
                const splitNotes = doc.splitTextToSize(notes, 170);
                
                splitNotes.forEach(line => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.text(line, 20, yPosition);
                    yPosition += 5;
                });
            }
            
            // Guardar PDF
            doc.save(`${projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
            
            updateStatus('Reporte PDF generado correctamente.');
        }
        
        // Actualizar barra de estado
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            
            // Cambiar color seg√∫n tipo
            statusBar.style.backgroundColor = type === 'error' ? '#ffebee' : '#e3f2fd';
            statusBar.style.color = type === 'error' ? '#d32f2f' : '#0d47a1';
        }
    </script>
</body>
</html>
